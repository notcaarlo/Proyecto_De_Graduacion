<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del Conductor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/perfil.css') }}">
</head>
<body>

<a href="{{ url_for('web_login.logout') }}" class="btn btn-danger-dark btn-soft btn-logout">Cerrar sesión</a>

<div class="container container-narrow py-5 text-center">
  <h2 class="mb-1">Bienvenido, {{ current_user.nombre }}</h2>
  <p class="text-muted-2 mb-4">Rol: <strong>{{ current_user.rol|capitalize }}</strong></p>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show w-75 mx-auto" role="alert">
          {{ msg }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if sesion_activa %}
    <div class="card-clean mx-auto p-4" style="max-width: 680px;">
      <h4 class="mb-3" style="color:#facc15">Jornada en curso</h4>
      <p class="mb-1 fs-5">Vehículo:
        <strong>{{ sesion_activa.vehiculo.codigo if sesion_activa.vehiculo else sesion_activa.id_vehiculo }}</strong>
      </p>
      <p class="text-muted-2 mb-4">Inicio: {{ sesion_activa.fecha_inicio.strftime('%d/%m/%Y %H:%M') }}</p>

      <div classs="mb-3">
        <h5 class="text-muted-2">Monitor en Vivo</h5>
        <img src="{{ url_for('conductor.video_feed') }}" width="640" height="480" 
             class="img-fluid rounded shadow-sm border border-secondary"
             alt="Monitor en vivo del detector de somnolencia">
      </div>
      <form method="POST" action="{{ url_for('conductor.finalizar_jornada') }}" class="mt-4">
        <button type="submit" class="btn btn-finalizar btn-lg w-75">Finalizar jornada</button>
      </form>
    </div>
  {% else %}
    {% if not tiene_asignacion %}
      <div class="alert alert-warning w-75 mx-auto mb-4">
        No tienes ningún vehículo asignado. Pide a un administrador que te asigne uno.
      </div>
    {% endif %}

    {% if tiene_asignacion %}
    <div class="row justify-content-center g-4">
      <div class="col-md-6">
        <div class="card-clean p-5 text-center" data-bs-toggle="modal" data-bs-target="#modalVehiculos" role="button">
          <h4 class="mb-1">Iniciar jornada</h4>
          <p class="text-muted-2 mb-0">Elige uno de tus vehículos asignados.</p>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="block mt-5 text-start historial">
      <div class="block-header">
        <strong>Historial de sesiones</strong>
        <button id="btnReload" class="btn btn-outline-light btn-sm">Recargar</button>
      </div>
      <div class="block-body p-0">
        <div class="table-responsive">
          <table class="table table-dark table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>ID</th><th>Vehículo</th><th>Inicio</th><th>Fin</th><th>Estado</th><th>Alertas</th>
              </tr>
            </thead>
            <tbody id="tabla-historial-body">
              <tr><td colspan="6" class="text-center py-4">Cargando…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<div class="modal fade" id="modalVehiculos" tabindex="-1" aria-labelledby="modalVehiculosLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalVehiculosLabel">Seleccionar Vehículo Asignado</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('conductor.iniciar_jornada') }}">
        <input type="hidden" name="vehiculo_id" id="vehiculo_id">
        <div class="modal-body">
          <div class="row g-2 mb-3">
            <div class="col-sm-6 col-md-4">
              <input id="vehiculos-search" type="text" class="form-control" placeholder="Filtrar por código, marca, modelo o placa…">
            </div>
          </div>
          <div class="table-responsive border rounded">
            <table class="table table-dark table-hover align-middle m-0" id="tabla-vehiculos">
              <thead>
                <tr>
                  <th style="width:80px;">ID</th>
                  <th style="width:140px;">Código</th>
                  <th>Vehiculo</th>
                  <th style="width:160px;">Placa</th>
                  <th style="width:120px;" class="text-center">Accion</th>
                </tr>
              </thead>
              <tbody>
                {% for v in vehiculos %}
                  <tr data-id="{{ v.id }}"
                      data-codigo="{{ v.codigo|e }}"
                      data-marca="{{ (v.marca or '')|e }}"
                      data-modelo="{{ (v.modelo or '')|e }}"
                      data-placa="{{ (v.placa or '')|e }}">
                    <td>{{ v.id }}</td>
                    <td>{{ v.codigo }}</td>
                    <td>{{ v.marca or '—' }} {{ v.modelo or '' }} {% if v.anio %}({{ v.anio }}){% endif %}</td>
                    <td>{{ v.placa or '—' }}</td>
                    <td class="text-center">
                      <button type="button" class="btn btn-sm btn-outline-info seleccionar-vehiculo">Elegir</button>
                    </td>
                  </tr>
                {% endfor %}
                {% if not vehiculos %}
                  <tr><td colspan="5" class="text-center py-4">No hay vehículos activos asignados.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" id="btn-iniciar" class="btn btn-primary-dark btn-soft" disabled>Iniciar jornada</button>
          <button type="button" class="btn btn-outline-light btn-soft" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function cargarHistorial(){
  const tbody = document.querySelector('#tabla-historial-body');
  if(!tbody) return;
  tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Cargando…</td></tr>';
  try{
    const r = await fetch('{{ url_for("conductor.historial_json") }}', { headers: { "Cache-Control": "no-cache" }});
    const data = await r.json();
    const rows = (data.sesiones||[]).map(s=>`
      <tr>
        <td>${s.id}</td>
        <td>${s.vehiculo}</td>
        <td>${s.inicio}</td>
        <td>${s.fin}</td>
        <td>${s.estado === 'activa' ? '<span class="badge badge-success">Activa</span>' : '<span class="badge badge-secondary">Finalizada</span>'}</td>
        <td><span class="badge text-dark" style="background:#f59e0b">${s.alertas}</span></td>
      </tr>`).join('');
    tbody.innerHTML = rows || '<tr><td colspan="6" class="text-center py-4">Sin registros.</td></tr>';
  }catch(e){
    console.error(e);
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Error al cargar.</td></tr>';
  }
}
document.getElementById('btnReload')?.addEventListener('click', cargarHistorial);
cargarHistorial(); setInterval(cargarHistorial, 10000);

const $tbody = document.querySelector('#tabla-vehiculos tbody');
const $search = document.getElementById('vehiculos-search');
const $vehiculoId = document.getElementById('vehiculo_id');
const $btnIniciar = document.getElementById('btn-iniciar');
function norm(t){return (t||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');}
function filtrar(){
  const f = norm($search.value||'');
  for(const row of $tbody.rows){
    const ok = !f || [row.dataset.codigo,row.dataset.marca,row.dataset.modelo,row.dataset.placa].some(v=>norm(v).includes(f));
    row.style.display = ok ? '' : 'none';
  }
}
function seleccionar(row){
  $vehiculoId.value = row.dataset.id;
  if($btnIniciar) $btnIniciar.disabled = false;
  for(const r of $tbody.rows){ r.classList.remove('table-active'); }
  row.classList.add('table-active');
}
$tbody?.addEventListener('click', e=>{
  const btn = e.target.closest('.seleccionar-vehiculo'); if(!btn) return;
  const row = btn.closest('tr'); if(row) seleccionar(row);
});
$search?.addEventListener('input', filtrar);
document.getElementById('modalVehiculos')?.addEventListener('shown.bs.modal', ()=>{
  if($search){ $search.value=''; $search.focus(); filtrar(); }
  if($btnIniciar){ $btnIniciar.disabled = !$vehiculoId.value; }
});
</script>
</body>
</html>