<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Detalle de usuario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin.css') }}">

  <style>
    .nivel-bajo { background: #10b981; }
    .nivel-medio { background: #f59e0b; }
    .nivel-alto { background: #991b1b; color: #fff; }
    .nivel-critico { background: #dc2626; color: #fff; }
    
    #ia-recomendacion-texto { min-height: 150px; }
    #ia-recomendacion-texto ul { padding-left: 20px; }
    #ia-recomendacion-texto strong { color: #facc15; }
    
    /* --- NUEVO: Altura fija para el gráfico para que coincida con el bloque de IA --- */
    #chart-container {
      position: relative;
      height: 300px; /* Ajusta esta altura si es necesario */
    }
  </style>
</head>

<body>

  <div class="container py-4 container-narrow">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h1 class="h4 m-0">{{ user.nombre }}</h1>
        <div class="text-muted-2">Usuario: {{ user.username }} · Rol: {{ user.rol|capitalize }}</div>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('admin_usuarios.listar_usuarios') }}" class="btn btn-outline-light btn-soft">← Volver</a>
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary btn-soft">Dashboard</a>
        <a href="{{ url_for('admin_usuarios.exportar_excel', id=user.id) }}" class="btn btn-outline-success btn-soft">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-spreadsheet-fill" viewBox="0 0 16 16" style="margin-top: -3px; margin-right: 2px;">
            <path d="M6 12v-2h3v2H6z"/>
            <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM3 9h10v1h-3v2h3v1h-3v2H3v-2h3v-1H3V9z"/>
          </svg>
          Exportar Excel
        </a>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card-clean p-3">
          <div class="text-muted-2">Total de sesiones</div>
          <div class="fs-3 fw-semibold">{{ total_sesiones }}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card-clean p-3">
          <div class="text-muted-2">Total de alertas</div>
          <div class="fs-3 fw-semibold">{{ total_alertas }}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card-clean p-3">
          <div class="text-muted-2">Alertas por nivel</div>
          <div>
            {% for nivel, cnt in niveles.items() %}
            <span class="badge badge-nivel me-1
            {% set n = (nivel or '')|lower %}
            {{ 'nivel-bajo' if n=='bajo' else ('nivel-medio' if n=='medio' else ('nivel-alto' if n=='alto' else ('nivel-critico' if n=='critico' else ''))) }}
           ">{{ nivel|capitalize }}: {{ cnt }}</span>
            {% else %}
            <span class="text-muted-2">—</span>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-6">
        <div class="block">
          <div class="block-header"><strong>Vehículos más usados</strong></div>
          <div class="block-body p-0">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Vehículo</th>
                  <th style="width:140px;">Sesiones</th>
                </tr>
              </thead>
              <tbody>
                {% for codigo, cnt in vehiculos_top %}
                <tr>
                  <td>{{ codigo }}</td>
                  <td>{{ cnt }}</td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="2" class="text-center py-4">Sin datos.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          </div>
      </div>
      <div class="col-lg-6">
        <div class="block">
          <div class="block-header"><strong>Últimas alertas</strong></div>
          <div class="block-body p-0">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th style="width:80px;">ID</th>
                  <th style="width:120px;">Fecha</th>
                  <th style="width:100px;">Hora</th>
                  <th>Nivel</th>
                  <th>Nota</th>
                </tr>
              </thead>
              <tbody>
                {% for a in ultimas_alertas %}
                {% set n = (a.nivel_somnolencia or '')|lower %}
                <tr>
                  <td>{{ a.id }}</td>
                  <td>{{ a.fecha.strftime('%d/%m/%Y') if a.fecha else '—' }}</td>
                  <td>{{ a.hora.strftime('%H:%M:%S') if a.hora else '—' }}</td>
                  <td>
                    <span class="badge badge-nivel
                      {{ 'nivel-bajo' if n=='bajo' else ('nivel-medio' if n=='medio' else ('nivel-alto' if n=='alto' else '') ) }}
                    ">{{ a.nivel_somnolencia or 'N/A' }}</span>
                  </td>
                  <td>{{ a.nota or '—' }}</td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="5" class="text-center py-4">Sin alertas.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          </div>
      </div>
    </div>

    <div class="row g-3 mt-3">
      
      <div class="col-lg-6">
        <div class="block">
          <div class="block-header"><strong>Distribución de alertas por nivel</strong></div>
          <div class="block-body">
            <div id="chart-container">
              <canvas id="chartAlertasNivel"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-6">
        <div class="block">
          <div class="block-header d-flex justify-content-between align-items-center">
            <strong>Análisis y Recomendación (IA)</strong>
            <button class="btn btn-outline-info btn-sm" id="btn-refresh-ia">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16" style="margin-top: -3px;">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
              </svg>
              Refrescar
            </button>
          </div>
          <div class="block-body">
            <div id="ia-recomendacion-texto" class="text-muted-2" data-id="{{ user.id }}">
              <div id="ia-loading-spinner" class="d-flex justify-content-center align-items-center" style="min-height: 150px;">
                <div class="spinner-border text-info" role="status">
                  <span class="visually-hidden">Generando análisis...</span>
                </div>
                <span class="ms-3">Generando análisis...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <script id="niveles-data" type="application/json">{{ niveles|tojson|safe }}</script>
  <script>
    const nivelesDataElement = document.getElementById('niveles-data');
    const niveles = JSON.parse(nivelesDataElement.textContent);
    const labels = Object.keys(niveles);
    const valores = Object.values(niveles);

    // Colores
    const colorPorNivel = (nivel) => {
      const n = (nivel || '').toLowerCase();
      if (n === 'bajo') return '#10b981';  // verde
      if (n === 'medio') return '#f59e0b';  // naranja
      if (n === 'alto') return '#991b1b';  // rojo oscuro
      if (n === 'critico') return '#dc2626';  // rojo brillante
      return '#64748b';
    };

    const backgroundColors = labels.map(colorPorNivel);
    const borderColors = labels.map(() => '#0b0f14');

    // Renderizar gráfica circular
    const ctx = document.getElementById('chartAlertasNivel');
    if (ctx) {
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            label: 'Alertas',
            data: valores,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 1
          }]
        },
        options: {
          // --- MODIFICADO: Mantenemos el aspect ratio ---
          responsive: true,
          maintainAspectRatio: false, // <-- Esto permite que llene el div (controlado por CSS)
          plugins: {
            legend: { position: 'bottom', labels: { color: '#e5e7eb', boxWidth: 20 } },
            tooltip: { enabled: true }
          }
        }
      });
    }
  </script>

  <script>
    (function() {
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        script.onload = function() {
            iniciarLogicaIA();
        };
        document.head.appendChild(script);
    })();

    function iniciarLogicaIA() {
      const btnRefresh = document.getElementById('btn-refresh-ia');
      const textoContainer = document.getElementById('ia-recomendacion-texto');
      const loadingSpinner = document.getElementById('ia-loading-spinner');
      const idUsuario = textoContainer.dataset.id;

      async function fetchRecomendacion() {
        loadingSpinner.style.display = 'flex';
        textoContainer.innerHTML = ''; 
        textoContainer.appendChild(loadingSpinner);
        btnRefresh.disabled = true;

        try {
          const response = await fetch(`/api/usuario/${idUsuario}/generar_recomendacion`);
          
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || `Error ${response.status}`);
          }
          const data = await response.json();
          const htmlRecomendacion = marked.parse(data.recomendacion);
          textoContainer.innerHTML = htmlRecomendacion;

        } catch (error) {
          console.error("Error al cargar recomendación:", error);
          textoContainer.innerHTML = `<p class="text-danger">Error al generar la recomendación: ${error.message}</p>`;
        } finally {
          loadingSpinner.style.display = 'none';
          btnRefresh.disabled = false;
        }
      }
      document.addEventListener('DOMContentLoaded', fetchRecomendacion);
      btnRefresh.addEventListener('click', fetchRecomendacion);
    }
  </script>
  </body>
</html>