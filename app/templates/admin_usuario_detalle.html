<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Detalle de usuario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin.css') }}">

  <!-- Colores para los niveles -->
  <style>
    .nivel-bajo {
      background: #10b981;
    }

    /* verde */
    .nivel-medio {
      background: #f59e0b;
    }

    /* naranja */
    .nivel-alto {
      background: #991b1b;
      color: #fff;
    }

    /* rojo oscuro */
    .nivel-critico {
      background: #dc2626;
      color: #fff;
    }

    /* rojo brillante para crítico */
  </style>
</head>

<body>

  <div class="container py-4 container-narrow">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h1 class="h4 m-0">{{ user.nombre }}</h1>
        <div class="text-muted-2">Usuario: {{ user.username }} · Rol: {{ user.rol|capitalize }}</div>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('admin_usuarios.listar_usuarios') }}" class="btn btn-outline-light btn-soft">← Volver</a>
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary btn-soft">Dashboard</a>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card-clean p-3">
          <div class="text-muted-2">Total de sesiones</div>
          <div class="fs-3 fw-semibold">{{ total_sesiones }}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card-clean p-3">
          <div class="text-muted-2">Total de alertas</div>
          <div class="fs-3 fw-semibold">{{ total_alertas }}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card-clean p-3">
          <div class="text-muted-2">Alertas por nivel</div>
          <div>
            {% for nivel, cnt in niveles.items() %}
            <span class="badge badge-nivel me-1
            {% set n = (nivel or '')|lower %}
            {{ 
              'nivel-bajo' if n=='bajo' else 
              ('nivel-medio' if n=='medio' else 
              ('nivel-alto' if n=='alto' else 
              ('nivel-critico' if n=='critico' else ''))) 
            }}
          ">{{ nivel|capitalize }}: {{ cnt }}</span>
            {% else %}
            <span class="text-muted-2">—</span>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- Vehículos más usados -->
      <div class="col-lg-6">
        <div class="block">
          <div class="block-header"><strong>Vehículos más usados</strong></div>
          <div class="block-body p-0">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Vehículo</th>
                  <th style="width:140px;">Sesiones</th>
                </tr>
              </thead>
              <tbody>
                {% for codigo, cnt in vehiculos_top %}
                <tr>
                  <td>{{ codigo }}</td>
                  <td>{{ cnt }}</td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="2" class="text-center py-4">Sin datos.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Últimas alertas -->
      <div class="col-lg-6">
        <div class="block">
          <div class="block-header"><strong>Últimas alertas</strong></div>
          <div class="block-body p-0">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th style="width:80px;">ID</th>
                  <th style="width:120px;">Fecha</th>
                  <th style="width:100px;">Hora</th>
                  <th>Nivel</th>
                  <th>Nota</th>
                </tr>
              </thead>
              <tbody>
                {% for a in ultimas_alertas %}
                {% set n = (a.nivel_somnolencia or '')|lower %}
                <tr>
                  <td>{{ a.id }}</td>
                  <td>{{ a.fecha.strftime('%d/%m/%Y') if a.fecha else '—' }}</td>
                  <td>{{ a.hora.strftime('%H:%M:%S') if a.hora else '—' }}</td>
                  <td>
                    <span class="badge badge-nivel
                      {{ 'nivel-bajo' if n=='bajo' else ('nivel-medio' if n=='medio' else ('nivel-alto' if n=='alto' else '') ) }}
                    ">{{ a.nivel_somnolencia or 'N/A' }}</span>
                  </td>
                  <td>{{ a.nota or '—' }}</td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="5" class="text-center py-4">Sin alertas.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Gráfica circular de alertas -->
      <div class="col-12">
        <div class="block">
          <div class="block-header"><strong>Distribución de alertas por nivel</strong></div>
          <div class="block-body">
            <canvas id="chartAlertasNivel" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- JSON seguro para niveles -->
  <script id="niveles-data" type="application/json">
  {{ niveles|tojson|safe }}
</script>

  <script>
    // Cargar datos desde el script JSON
    const nivelesDataElement = document.getElementById('niveles-data');
    const niveles = JSON.parse(nivelesDataElement.textContent);

    const labels = Object.keys(niveles);
    const valores = Object.values(niveles);

    // Colores
    const colorPorNivel = (nivel) => {
      const n = (nivel || '').toLowerCase();
      if (n === 'bajo') return '#10b981';  // verde
      if (n === 'medio') return '#f59e0b';  // naranja
      if (n === 'alto')     return '#991b1b';  // rojo oscuro
      if (n === 'critico')  return '#dc2626';  // rojo brillante
      return '#64748b';
    };

    const backgroundColors = labels.map(colorPorNivel);
    const borderColors = labels.map(() => '#0b0f14');

    // Renderizar gráfica circular
    const ctx = document.getElementById('chartAlertasNivel');
    if (ctx) {
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            label: 'Alertas',
            data: valores,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#e5e7eb', boxWidth: 20 }
            },
            tooltip: { enabled: true }
          }
        }
      });
    }
  </script>
</body>

</html>